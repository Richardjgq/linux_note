# 负载均衡

#### **什么是负载均衡?**

负载均衡（Load Balance）是分布式系统架构设计中必须考虑的因素之一 , 它通常是指 , 将请求/数据【均匀】分摊到多个操作单元上执行 , 负载均衡的关键在于【均匀】.

#### **负载均衡常见架构**

![](/assets/fuzaijunheng.png)

客户端层 , 反向代理nginx层 , 站点层 , 服务层 , 数据层 , 每一个下游都有多个上游调用 , 只需要做到 , 每一个上游都均匀访问每一个下游 , 这些都是“负载均衡” .

用户\(也就是client\)访问一个网址 , 首先通过DNS解析为IP地址 , 返回给我们10.58.0.1 , 然后访问这个IP地址 , 通过TCP协议\(HTTP协议封装的IP/TCP协议\) , 找到nginx服务器 , 这里就用到**负载均衡** , 转到了其中一台nginx服务器上 , 然后nginx通过反向代理负载均衡 , 继续分发请求 , 找到其中一台web-server服务器 . web-server后又经过**负载均衡** , 找到服务化的层面 , 也就是常见的功能拆分 , 比如用户中心服务 , 文件上传服务等 , 最后服务层访问的数据层 , 也可能不是一台服务器 , 也需要做**负载均衡**的分发 .

#### 负载均衡的工作方式

**1\) http重定向**

当http代理（比如浏览器）向web服务器请求某个URL后 , web服务器可以通过http响应头信息中的Location标记来返回一个新的URL . 这意味着HTTP代理需要继续请求这个新的URL , 完成自动跳转 .

**缺点 : 吞吐率限制 , 转发的请求会变成2个 , 第一次在访问请求 , 第二次是转发请求 . **

**优点 : 不需要任何额外支持**

适用场景：我们需要权衡转移请求的**开销和处理实际请求的开销**，**前者相对于后者越小，那么重定向的意义就越大**，例如下载 , 下载一个100M的文件 , 这个链接需要占用一段时间 , 而转发可能只需毫秒级别 , 这就是前者小与后者的意思 . 你可以去很多镜像下载网站试下 , 会发现基本下载都使用了Location做了重定向 .

**2\) DNS负载均衡**

DNS 负责提供域名解析服务 , 当访问某个站点时 , 实际上首先需要通过该站点域名的DNS服务器来获取域名指向的IP地址 , 就是我们访问一个站点 , 返回的IP是不同的 .在这一过程中 , DNS服务器完成了域名到IP地址的映射 , 同样 , 这样映射也可以是一对多的 , 这时候 , DNS服务器便充当了负载均衡调度器 .

使用命令 : `dig baidu.com`查看DNS的配置 .

DNS服务器可以在所有可用的A记录中寻找离用记最近的一台服务器 .

**缺点 :  DNS记录缓存更新不及时、策略的局限性、不能做健康检查 . 比如更换IP , 更新就可能会不及时 . 某一个IP失效 , 健康检查也是问题 . **

**优点 : 可以寻找最近的服务器 , 加快请求速度 . **

适用场景 : 一般我们在多机房部署的时候 , 可以使用 .

**3\) 反向代理负载均衡**

在用户的请求到达反向代理服务器时\(已经到达网站机房\) , 由反向代理服务器根据算法转发到具体的服务器 . 常用的apache , nginx都可以充当反向代理服务器 . 反向代理的调度器扮演的是用户和实际服务器中间人的角色 .

工作在HTTP层\(七层\) , 实际转发的也是HTTP请求 .

**缺点 : 代理服务器成为性能的瓶颈 , 特别是一次上传大文件 . 充当了中间传输人的角色 , 所以代理服务器会成为系统的瓶颈 . 尤其是网卡 , 如果1个人下载10M , 100个人下载 , 千兆网卡就不行了 . 最大访问量 , 负载能力只有100 . **

**所有的请求都要经过代理服务器 , 服务器的CPU,内存等 , 也都会成为瓶颈点 . **

**优点 : 配置简单、策略丰富\(比如加权重\)、维持用户会话\(比如同一IP访问同一台机器\)、可根据访问路径做转发\(因为是HTTP请求\) . **

适用场景 : 请求量不高的 , 简单负载均衡 . 后端开销较大的应用\(比如一个请求过来 , 后端需要运算一段时间 , 瓶颈转到了后端的开销\) .

> **什么是代理 ? **
>
> 代理在普通生活中的意义就是本来应该你做的事情 , 你让别人代你做了 , 那么那个帮你做的人就是你的代理 . 而在计算机网络中代理的概念差不多 , 就是本来要客户端要做的网络访问 , 现在移交给另外一个机器做 , 那么那个机器就被称为代理服务器 , 代理服务器帮你来访问 . 过程如下 :
>
> 正常情况：
>
> client —\(send request\)—&gt;server
>
> 代理情况 :
>
> client —\(send request\)—&gt;clinet proxy –\(send request\)—&gt;server
>
> **什么是反向代理 ? **
>
> 反向代理在计算机网络中是指这么一个过程 . 一般来说正向代理是客户机找人来代理把自己的请求转发给服务端 , 但是如果反向代理 , 找代理的人不再是客户机，而是服务器这边把自己接受的请求转发给背后的其他机器 . 其主要区别 :
>
> * 正向代理中代理的过程是客户端 , 代理机器是作为一个访问客户的身份的 . 而在反向代理中代理机器是作为服务身份 . 
> * 正向代理中代理的过程是客户端 , 服务端对代理的存在无感知 . 而在反向代理中客户机对代理的存在无感知 .

**4\) IP负载均衡**

工作在传输层\(四层\) , 所以IP负载均衡又叫四层转发负载均衡 .

通过操作系统内修改发送来的IP数据包 , 将数据包的目标地址修改为内部实际服务器地址 , 从而实现请求的转发 , 做到负载均衡 . lvs软件的nat模式 , 其实就是ip转发过来的数据包 , 也就是ip负载均衡 .

**缺点 : 所有数据进出还是要过负载机器 , 网络带宽成为瓶颈 . 和反向代理服务器的方式是一样的 . **

**优点 : 内核完成转发 , 性能高 . 也是相对反向代理的优点 , 不是通过反向代理软件转发的 . **

适用场景 : 对性能要求高 , 但对带宽要求不高的的应用 , 比如一些数据量传输不大的API接口 . 视频和下载等大带宽的应用 , 并不适合使用 .

![](/assets/ipfuzaijunheng.png)

  
**5\) 数据链路层的负载均衡**

工作在数据链路层\(二层\)

在请求到达负载均衡器后 , 通过配置所有集群机器的虚拟ip和负载均衡器相同 , 再通过修改请求的mac地址 , 从而做到请求的转发 . 与IP负载均衡不一样的是 , 当请求访问完服务器之后 , 直接返回客户 . 而无需再经过负载均衡器 . 也就是LVS DR\(Direct Routing\)模式 . 

**缺点 : 配置复杂**

**优点 : 由集群机器直接返回 , 提高了出口带宽 . **

适用场景 : 大型网站使用最广的一种负载均衡方法 . 



