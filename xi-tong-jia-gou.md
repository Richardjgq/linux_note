# 系统架构

#### 大型网站的特点 ?

**海量数据** : 淘宝有15亿件商品

**高并发** : 同一时间访问人数 , 大流量 , googl日均pv35亿

**高可用** : 系统7x24小时不间断的服务

**功能多, 需求多, 发版频繁** : 一般每周都有新版本更新上线

#### 单机构建网站

网站初期 , 经常会在单机上跑外面所有的程序和软件 , 比如 : LNMP .

**要考虑的问题 : **

* 如何估算当前系统能承载多少负载量?
* 常用的性能测试工具有哪些?
* 如何查看机器的负载?

例 :

市场部搞一个很大的运营活动 , 领导过来问两个问题 :

* 访问量能撑住么?
* 如果撑不住 , 还需要加多少台机器 ? 

新系统设计阶段 , 领导又过来问了两个问题 :

* 咱们的数据库需要分库么?
* 如果需要分库 , 需要分几个库?

前面的问题都设计到一个问题 :

**容量的估算**

容量估算需要估算什么?

* 常见的容量估算包括数据量 , **并发量** , 带宽 , CPU/MEM/DISK等 . 做为互联网项目最重要的是**并发量**的估算 . 

容量评估的步骤与方法 :

* 评估总访问量 : PV , 根据预期计算 . 
* 评估平均访问量QPS : 每天的访问量/白天的时间 , 即 pv/12h\*3600秒
* 评估QPS高峰 : 平均值的2-2.5倍作为高峰值 . 
* 评估系统 , 单机极限QPS : 高峰QPS与单机极限QPS对比评估
* 计算容量

**常见性能测试工具**

* ab - ApacheBench 是Apache自带的压力测试工具 , 可以用来测试各种Web服务器的压力 . 
* JMeter -  Apache JMeter是Apache组织开发的基于Java的压力测试工具 . 
* LoadRunner - 一种适用于各种体系架构的自动负载测试工具 , 功能非常强大 . 

**关于系统负载**

什么是系统负载？

系统负载\(System Load\) - 是系统CPU繁忙程度的度量 , 即有多少进程在等待被CPU调度\(进程等待队列的长度\)

平均负载\(Load Average\) - 是一段时间内系统的平均负载 , 这个一段时间一般取1分钟、5分钟、15分钟 .

如何查看系统的负载情况？

top，uptime，w等命令都可以查看系统负载 . 分别是1分钟 , 5分钟 , 15分钟

* top - 查看load average: 0.00, 0.00, 0.00
* uptime - 也可以打印出当前系统的负载值 , load averages: 2.64 2.52 2.43
* w - load averages: 2.00 2.37 2.38

**负载的含义**

把CPU比喻成一条（单核）马路，进程任务比喻成马路上跑着的汽车，Load则表示马路的繁忙程度。

![](/assets/fuzaidhanyi.png)

  
**什么样的Load值得警惕?**

以单核为例：

* **Load &lt; 0.7时** - 系统很闲 , 马路上没什么车 , 要考虑多部署一些服务 . 
* **0.7 &lt; Load &lt; 1时** - 系统状态不错 , 马路可以轻松应对 . 
* **Load = 1时** - 系统马上要处理不多来了 , 赶紧找一下原因 . 
* **Load &gt; 2时** - 马路已经非常繁忙了 , 进入马路的每辆汽车都要无法很快的运行 . 
* **Load &gt; 5时** - 系统要崩溃了 . 

---

#### 应用数据库与服务器分离

假如我们代码层面已难以优化,在不对代码和结构不做大调整的情况下,再增加一台机器是一个最简单的选择. 如果现在有两台服务器 , 分拆数据库是最好的选择 , 例如PHP与MySQL就是解耦的 . 

**如何选择机器的（webapp和数据库对机器的要求）配置？**

* 应用服务器\(常见的Nginx和PHP\)需要处理大量的逻辑 , 所以需要强大的CPU
* 文件服务器需要存储大量用户上传的文件 , 所以需要更大的硬盘
* 数据库服务器需要快速磁盘检索和数据缓存 , 所以需要更大的内存和更快的硬盘



